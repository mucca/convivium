<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
       "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
  <title>
    Convivium - <%= controller.controller_name %>:<%= controller.action_name %>
  </title>     
  <% stylesheet_link_tag 'print' %>     
  <%= stylesheet_link_tag 'screen' %>   
  <%= stylesheet_link_tag 'style' %>   
  <!--[if IE]>           
  <%= stylesheet_link_tag 'ie' %>     
  <![endif]-->       
  <%= stylesheet_link_tag 'scaffold' %>
  <%= stylesheet_link_tag 'global' %>
  <%= stylesheet_link_tag 'flick/jquery-ui.css' %>
  <%= stylesheet_link_tag 'jquery.gritter.css' %>

  <%= stylesheet_link_tag 'scaffold' %>
  <%= stylesheet_link_tag 'global' %>

  <%= javascript_include_tag :defaults %>  
  <%= javascript_include_tag 'jquery.gritter.js' %>
  <%= javascript_include_tag 'jquery.fcbkcomplete.js' %>
  
  
  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){    
      
      function sync_group_users(item) { 
        if (typeof(item) == "string") {         
          var item = eval("item=" + item);  
        }
        if (typeof(item) != "object") {
          return true;
        }       
        type = item._value.split(":")[0];
        id = item._value.split(":")[1];     
        if (type == "user") {
          $("#expense_users option[value="+id+"]").attr("selected","selected");
        } 
        if (type == "expensegroup") {
          $("#expense_expensegroups option[value="+id+"]").attr("selected","selected");  
          $("li[rel="+item._value+"]").addClass('group-box');
          push_group_users(id, "#dummy_user_group");
        }
      } 
      
      function deselect_removed(item){
        if (typeof(item) == "string") {         
          var item = eval("item=" + item);  
        }
        if (type == "user") {
          $("#expense_users option[value="+id+"]").attr("selected","");
        } 
        if (type == "expensegroup") {
          $("#expense_expensegroups option[value="+id+"]").attr("selected","");  
        }
      }
      
      function push_group_users(group_id, target) {    
        $.ajax({
          url: "<%= url_for :controller => 'expenses', :action => 'group_users' %>",
          data: "group_id=" + group_id,
          dataType: "html",
          success: function(data) {   
            if (!target){
              target = "#expense_expensegroup_ids";
            }
            $(target).trigger("addItem", [eval(data)]);
          }
        });
      }
                         
      $("#expense_users").hide();
      $("#expense_expensegroups").hide();
      
      $("#expense_user_ids, #expensegroup_user_ids").val("").html(""); 
             
      $("#dummy_user_group").fcbkcomplete({
        json_url: "<%= url_for :controller => 'expenses', :action => 'users_and_groups_autocomplete' %>",
        cache: true,
        onselect: sync_group_users,
        onremove: deselect_removed, 
        filter_case: true,
        filter_hide: true,
        newel: false,
        firstselected : true
      });   
      
      $("#expensegroup_user_ids").fcbkcomplete({
        json_url: "<%= url_for :controller => 'expenses', :action => 'users_autocomplete' %>",
        cache: true,
        filter_case: true,
        filter_hide: true,
        newel: false,
        firstselected : true
      });   
      
      $("#expense_user_ids").fcbkcomplete({
        json_url: "<%= url_for :controller => 'expenses', :action => 'users_autocomplete' %>",
        cache: true,
        filter_case: true,
        filter_hide: true,
        newel: false,
        firstselected : true
      });
      
      $("#expense_expensegroup_ids").fcbkcomplete({
        json_url: "<%= url_for :controller => 'expenses', :action => 'users_autocomplete' %>",
        cache: true,
        onselect: push_group_users, 
        filter_case: true,
        filter_hide: true,
        newel: false,
        firstselected : true
      });
      
                 
      <% if @users_expense %>
        $("#expense_user_ids").trigger("addItem", [<%= @users_expense %>]);        
      <% end %>
      
      <% if @users_expensegroup %>
        $("#expensegroup_user_ids").trigger("addItem", [<%= @users_expensegroup %>]);
      <% end %>
      
      <% if @expense_expensegroup %>
        $("#expense_expensegroup_ids").trigger("addItem", [<%= @expense_expensegroup %>]);    
      <% end %>
      
    }); 
    
  </script>
  
  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
        
        $("#column-right ul li a").button({ icons: {primary:'ui-icon-folder-collapsed'} });
        $("#column-right ul li.users_link a").button({ icons: {primary:'ui-icon-person'} });
        $("input[type=submit]").button({ icons: {primary:'ui-icon-folder-collapsed'} });
        $("ul.expense-year-list li a").button({ icons: {primary:'ui-icon-calculator'} });
        $("ul.expense-year-list li a").button({ icons: {primary:'ui-icon-calculator'} });
        
        $(".jquery-date-picker").each(function(){
            $(this).datepicker({ dateFormat: 'yy-mm-dd',constrainInput: false });
        });
        $(".skip-import-submit").click(function(){
            $(this).parent('form').remove();
            return false;
        });
    })
  </script>
</head>
<body>
<div id="main-container">
    <div id="application-content" class="clearfix">  
      <div id="top-menu">
      <h1>Convivium</h1>
      <div id="actions-container">
          <% if current_user %>
              <%= t 'Hi' %> <%= name_or_login current_user %>
              <%= link_to t('Logout'), { :controller => "sessions" , :action => "destroy"} %>
          <% end %>
          </div>
          <div style="clear:both"></div>
      </div>    
    <% if current_user %>
    <div id="column-right">
        <ul>
            <li><%= link_to t("Report"), expenses_path %></li>
            <li><%= link_to t("Complete report"), {:controller => "report" , :action => "expense_report"} %></li>
            <li><%= link_to t("History"), {:controller => "report" , :action => "history"} %></li>
            <li><%= link_to t("Add expense"), new_expense_path %></li>
            <li><%= link_to t("Expense groups"), expensegroups_path %></li>
            <li><%= link_to t("Categories"), categories_path %></li>
            <li class="users_link"><%= link_to t("Users"), users_path %></li>
        </ul>
        <%= yield :portlets %>
    </div>
    <div id="column-content" class="ui-corner-all">   
    <% end %>
      <% if flash[:notice] %>
        <div class="flash notice" id='notice'> <%= flash[:notice] %></div>
      <% end %>
      
      <% if flash[:error] %>    
        <div class="flash error" id='error'><%= flash[:error] %></div>
      <% end %> 
      <%= yield %>     
      <br class="clear"/>    
   </div>
   </div>
</div>

</body>
</html>
